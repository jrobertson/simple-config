#!/usr/bin/env ruby

# file: simple-config.rb

require 'kvx'


class SimpleConfig < Kvx
  
  attr_reader :to_h, :to_s
  
  def initialize(x=nil, attributes: {})    

    @header = false
    @attributes = attributes
    m = {:String => :parse_to_h, :Hash => :write, :SimpleConfig => :passthru}
    
    method(m[x.class.to_s.to_sym]).call(x) if x
  end
                          
  def write(h=nil, header: @header)
    
    @to_h = h || @to_h

    header = ''
    
    if @header then
      
      header = '<?simple-config'
      header += ' ' + @attributes.map {|x| "%s='%s'" % x }.join(' ')
      header += "?>\n"
    end
    
    @to_s = header + scan_to_s(@to_h)

  end  
     
  private
  
  def parse_to_h(s)
    super(s, header_pattern: %r(^<\?simple-?config ))
  end
    
  def passthru(x)
    initialize x.to_h
  end  

  def scan_to_s(h, indent='')    
    
    a = h.inject([]) do |r, x|
      if x.last.is_a? Hash then
        r << x.first.to_s + ":\n" + scan_to_s(x.last, '  ')
      else
        r << "%s%s: %s" % [indent, *x]
      end
    end
    
    @to_s = a.join("\n")
  end

end